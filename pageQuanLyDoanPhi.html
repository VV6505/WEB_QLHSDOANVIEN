<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý Đoàn Phí - Demo Tương Tác</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary-blue: #436ef3;
        --bg-light: #f4f7fa;
        --text-dark: #333;
        --text-gray: #666;
        --success: #28c76f;
        --danger: #ea5455;
        --card-purple: #7367f0;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: var(--bg-light);
        padding-bottom: 90px;
      }

      /* HEADER */
      .header {
        background-color: var(--primary-blue);
        color: white;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .header-title h2 {
        font-size: 24px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .btn-logout {
        background: white;
        color: var(--primary-blue);
        border: none;
        padding: 5px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
      }

      /* CONTAINER */
      .container {
        max-width: 1200px;
        margin: 25px auto;
        padding: 0 15px;
      }

      /* DASHBOARD CARDS */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 25px;
      }
      .stat-card {
        padding: 20px;
        border-radius: 12px;
        color: white;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }
      .stat-card:hover {
        transform: translateY(-5px);
      }
      .bg-blue {
        background: linear-gradient(45deg, #436ef3, #5a80f5);
      }
      .bg-green {
        background: linear-gradient(45deg, #28c76f, #48da89);
      }
      .bg-red {
        background: linear-gradient(45deg, #ea5455, #ff7677);
      }
      .bg-purple {
        background: linear-gradient(45deg, #7367f0, #938af5);
      }

      .stat-value {
        font-size: 32px;
        font-weight: bold;
        text-align: right;
      }
      .stat-label {
        font-size: 14px;
        opacity: 0.9;
      }

      /* CONTENT BOX */
      .content-box {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      }
      .box-header {
        margin-bottom: 25px;
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
      }
      .box-title {
        font-size: 22px;
        font-weight: bold;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* FILTERS */
      .filter-bar {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
      }
      .search-input {
        flex: 2;
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        min-width: 200px;
        outline: none;
      }
      .select-input {
        flex: 1;
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        outline: none;
        cursor: pointer;
        min-width: 150px;
        background-color: white;
      }
      .select-input:focus,
      .search-input:focus {
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(67, 110, 243, 0.1);
      }
      .btn-filter {
        background: var(--primary-blue);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .btn-filter:hover {
        background-color: #325ad8;
      }

      .year-tabs {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
      }
      .year-badge {
        background: #eef2fe;
        color: var(--primary-blue);
        padding: 8px 20px;
        border-radius: 30px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.3s;
        border: 1px solid transparent;
      }
      .year-badge.active {
        background: var(--primary-blue);
        color: white;
        box-shadow: 0 4px 10px rgba(67, 110, 243, 0.3);
      }

      /* TABLE STYLES */
      .table-responsive {
        overflow-x: auto;
        min-height: 300px;
        max-height: 600px;
      }
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 10px;
      }
      th {
        text-align: left;
        padding: 18px 15px;
        background: #f8f9fa;
        color: #555;
        font-weight: 600;
        border-bottom: 2px solid #eee;
        white-space: nowrap;
        position: sticky;
        top: 0;
        background: #f8f9fa;
        z-index: 10;
      }
      td {
        padding: 15px;
        border-bottom: 1px solid #eee;
        color: var(--text-dark);
        vertical-align: middle;
      }
      tr:hover td {
        background-color: #fafbfc;
      }

      /* BADGES */
      .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }
      .badge-success {
        background: #dff7e9;
        color: var(--success);
      }
      .badge-danger {
        background: #fcecea;
        color: var(--danger);
      }
      .badge-faculty {
        background: #eee;
        color: #555;
        font-weight: 600;
        border: 1px solid #ddd;
      }

      /* ACTION BUTTONS */
      .btn-action {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
        border: none;
        font-weight: 600;
        transition: 0.2s;
      }
      .btn-confirm {
        background: white;
        border: 1px solid var(--success);
        color: var(--success);
      }
      .btn-confirm:hover {
        background: var(--success);
        color: white;
      }

      .btn-detail {
        background: #e3e8fc;
        color: var(--primary-blue);
      }
      .btn-detail:hover {
        background: var(--primary-blue);
        color: white;
      }

      .btn-back {
        background: transparent;
        border: none;
        color: #666;
        font-size: 16px;
        cursor: pointer;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
      }
      .btn-back:hover {
        color: var(--primary-blue);
      }

      /* STICKY FOOTER */
      .sticky-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: white;
        padding: 15px 40px;
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        align-items: center;
        z-index: 999;
        border-top: 1px solid #eee;
      }
      .footer-left {
        margin-right: auto;
        font-size: 15px;
        color: #555;
      }
      .footer-btn {
        padding: 12px 24px;
        border-radius: 8px;
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: 0.2s;
      }
      .footer-btn:active {
        transform: scale(0.98);
      }
      .btn-purple {
        background-color: var(--card-purple);
      }
      .btn-blue {
        background-color: var(--primary-blue);
      }
      .btn-gray {
        background-color: #6c757d;
      }

      .hidden {
        display: none;
      }
      .file-link {
        color: var(--primary-blue);
        text-decoration: none;
        font-weight: 500;
      }
      .file-link:hover {
        text-decoration: underline;
      }

      .no-result {
        text-align: center;
        padding: 30px;
        color: #888;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-title">
        <h2><i class="fas fa-coins"></i> Hệ Thống Quản Lý Đoàn Phí</h2>
      </div>
      <div class="user-info">
        <span><i class="fas fa-user-circle"></i> Admin - Ban Thường vụ</span>
        <button class="btn-logout">Đăng xuất</button>
      </div>
    </header>

    <div class="container">
      <div class="stats-grid">
        <div class="stat-card bg-blue">
          <div><i class="fas fa-building"></i> Tổng chi đoàn</div>
          <div class="stat-value" id="stat-total-class">0</div>
          <div class="stat-label">Đang quản lý</div>
        </div>
        <div class="stat-card bg-green">
          <div><i class="fas fa-check-circle"></i> Đã hoàn thành</div>
          <div class="stat-value" id="stat-completed">0</div>
          <div class="stat-label">Các chi đoàn đóng đủ</div>
        </div>
        <div class="stat-card bg-red">
          <div><i class="fas fa-exclamation-triangle"></i> Chưa hoàn thành</div>
          <div class="stat-value" id="stat-incomplete">0</div>
          <div class="stat-label">Cần nhắc nhở</div>
        </div>
        <div class="stat-card bg-purple">
          <div><i class="fas fa-wallet"></i> Tổng thu</div>
          <div class="stat-value">38.5 Tr</div>
          <div class="stat-label">VND (Năm học 2023-2024)</div>
        </div>
      </div>

      <div class="content-box">
        <div id="view-chidoan">
          <div class="box-header">
            <div class="box-title">
              <i class="fas fa-list-ul"></i> Danh Sách Chi Đoàn - Tổng Hợp
            </div>
          </div>

          <div class="year-tabs">
            <span
              style="
                display: flex;
                align-items: center;
                margin-right: 10px;
                font-weight: 600;
              "
              >Năm học:</span
            >
            <span class="year-badge active">2023-2024</span>
            <span class="year-badge">2024-2025</span>
            <span class="year-badge">2025-2026</span>
          </div>

          <div class="filter-bar">
            <input
              type="text"
              id="search-text"
              class="search-input"
              placeholder="Tìm kiếm tên lớp..."
              onkeyup="filterClasses()"
            />
            <select
              id="filter-faculty"
              class="select-input"
              onchange="filterClasses()"
            >
              <option value="">-- Tất cả Khoa --</option>
            </select>
            <select
              id="filter-status"
              class="select-input"
              onchange="filterClasses()"
            >
              <option value="">-- Tất cả trạng thái --</option>
              <option value="1">Đã hoàn thành</option>
              <option value="0">Chưa hoàn thành</option>
            </select>
            <button class="btn-filter" onclick="filterClasses()">
              <i class="fas fa-filter"></i> Áp dụng
            </button>
          </div>

          <div class="table-responsive">
            <table id="table-classes">
              <thead>
                <tr>
                  <th>STT</th>
                  <th>Tên Chi Đoàn</th>
                  <th>Khoa</th>
                  <th>Sĩ số</th>
                  <th>Đã thu</th>
                  <th>Tiến độ</th>
                  <th>Trạng thái</th>
                  <th>Minh chứng</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody id="tbody-classes"></tbody>
            </table>
            <div id="no-result-msg" class="no-result hidden">
              Không tìm thấy lớp nào phù hợp bộ lọc.
            </div>
          </div>
        </div>

        <div id="view-sinhvien" class="hidden">
          <button class="btn-back" onclick="backToClassList()">
            <i class="fas fa-arrow-left"></i> Quay lại danh sách lớp
          </button>

          <div class="box-header">
            <div class="box-title">
              Chi tiết thu phí - Lớp
              <span
                id="current-class-name"
                style="color: var(--primary-blue); margin-left: 8px"
                >...</span
              >
            </div>
          </div>

          <div class="filter-bar">
            <input
              type="text"
              class="search-input"
              placeholder="Nhập MSSV hoặc tên sinh viên..."
            />
            <select class="select-input">
              <option>Tất cả trạng thái</option>
              <option>Đã đóng</option>
              <option>Chưa đóng</option>
            </select>
            <button class="btn-filter">
              <i class="fas fa-search"></i> Tìm kiếm
            </button>
          </div>

          <div class="table-responsive">
            <table id="table-students">
              <thead>
                <tr>
                  <th><input type="checkbox" id="check-all" /></th>
                  <th>MSSV</th>
                  <th>Họ tên</th>
                  <th>Ngày sinh</th>
                  <th>Số tiền</th>
                  <th>Trạng thái</th>
                  <th>Ngày đóng</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody id="tbody-students"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="sticky-footer" id="footer-actions">
      <div class="footer-left">
        Đã chọn:
        <b
          id="selected-count"
          style="color: var(--primary-blue); font-size: 18px"
          >0</b
        >
        sinh viên
      </div>
      <button class="footer-btn btn-purple">
        <i class="fas fa-file-invoice"></i> Lập phiếu thu
      </button>
      <button class="footer-btn btn-blue">
        <i class="fas fa-file-export"></i> Xuất Excel
      </button>
      <button class="footer-btn btn-gray">
        <i class="fas fa-paper-plane"></i> Gửi nhắc nhở
      </button>
    </div>

    <script>
      // 1. TẠO DỮ LIỆU GIẢ: ĐA DẠNG KHÓA VÀ ÍT LỚP
      const facultyMap = {
        CNTT: "T",
        "Kiến trúc": "KT",
        "Môi trường": "MT",
        "Cơ khí": "C",
        "Xây dựng": "XD",
        "Điện - Điện tử": "DT",
      };

      const cohorts = ["21", "22", "23"];
      let classList = [];
      let classIdCounter = 1;

      Object.keys(facultyMap).forEach((facultyName) => {
        const facultyCode = facultyMap[facultyName];
        cohorts.forEach((year) => {
          const numberOfClasses = 2 + Math.floor(Math.random() * 3);
          for (let i = 1; i <= numberOfClasses; i++) {
            const total = 30 + Math.floor(Math.random() * 20);
            const collected = Math.floor(Math.random() * (total + 1));
            const isComplete = collected === total;

            const className = `${year}${facultyCode}${i}`;
            classList.push({
              id: `CLASS_${classIdCounter++}`,
              name: className,
              faculty: facultyName,
              total: total,
              collected: collected,
              status: isComplete,
              file: isComplete ? `bien_lai_${className}.pdf` : null,
            });
          }
        });
      });

      document.getElementById("stat-total-class").innerText = classList.length;
      document.getElementById("stat-completed").innerText = classList.filter(
        (c) => c.status
      ).length;
      document.getElementById("stat-incomplete").innerText = classList.filter(
        (c) => !c.status
      ).length;

      // 2. KHỞI TẠO DROPDOWN KHOA
      function initFacultyFilter() {
        const select = document.getElementById("filter-faculty");
        const uniqueFaculties = Object.keys(facultyMap).sort();
        uniqueFaculties.forEach((fac) => {
          const option = document.createElement("option");
          option.value = fac;
          option.innerText = fac;
          select.appendChild(option);
        });
      }

      // 3. RENDER TABLE
      function filterClasses() {
        const searchText = document
          .getElementById("search-text")
          .value.toLowerCase();
        const filterFaculty = document.getElementById("filter-faculty").value;
        const filterStatus = document.getElementById("filter-status").value;

        const tbody = document.getElementById("tbody-classes");
        tbody.innerHTML = "";
        let hasResult = false;
        let countVisible = 0;

        classList.forEach((cls) => {
          const matchName = cls.name.toLowerCase().includes(searchText);
          const matchFaculty =
            filterFaculty === "" || cls.faculty === filterFaculty;
          let matchStatus = true;
          if (filterStatus === "1") matchStatus = cls.status === true;
          if (filterStatus === "0") matchStatus = cls.status === false;

          if (matchName && matchFaculty && matchStatus) {
            hasResult = true;
            countVisible++;
            const percent = Math.round((cls.collected / cls.total) * 100);
            const statusBadge = cls.status
              ? `<span class="badge badge-success"><i class="fas fa-check"></i> Hoàn thành</span>`
              : `<span class="badge badge-danger">Chưa xong</span>`;
            const fileHtml = cls.file
              ? `<a href="#" class="file-link"><i class="fas fa-paperclip"></i> ${cls.file}</a>`
              : `<span style="color:#bbb; font-style:italic">Chưa nộp</span>`;

            const row = `
                        <tr>
                            <td>${countVisible}</td>
                            <td style="font-weight:bold; color:var(--primary-blue)">${
                              cls.name
                            }</td>
                            <td><span class="badge badge-faculty">${
                              cls.faculty
                            }</span></td>
                            <td>${cls.total}</td>
                            <td><b>${cls.collected}</b>/${cls.total}</td>
                            <td>
                                <div style="width: 100px; height: 6px; background: #eee; border-radius: 3px; overflow: hidden;">
                                    <div style="width: ${percent}%; height: 100%; background: ${
              cls.status ? "var(--success)" : "var(--danger)"
            }"></div>
                                </div>
                                <small style="font-size:11px; color:#777">${percent}%</small>
                            </td>
                            <td>${statusBadge}</td>
                            <td>${fileHtml}</td>
                            <td>
                                <button class="btn-action btn-detail" onclick="openClassDetail('${
                                  cls.name
                                }', ${cls.total})">
                                    <i class="fas fa-eye"></i> Xem DS
                                </button>
                            </td>
                        </tr>
                    `;
            tbody.innerHTML += row;
          }
        });

        const msg = document.getElementById("no-result-msg");
        if (!hasResult) msg.classList.remove("hidden");
        else msg.classList.add("hidden");
      }

      // ==========================================
      // CÁC HÀM XỬ LÝ SINH VIÊN
      // ==========================================
      function generateStudents(count) {
        const students = [];
        const firstNames = [
          "Nguyễn",
          "Trần",
          "Lê",
          "Phạm",
          "Hoàng",
          "Huỳnh",
          "Phan",
          "Vũ",
          "Đặng",
        ];
        const middleNames = ["Văn", "Thị", "Minh", "Thanh", "Đức", "Hữu", "Mỹ"];
        const lastNames = [
          "An",
          "Bình",
          "Cường",
          "Dũng",
          "Giang",
          "Hương",
          "Hùng",
          "Linh",
          "Tùng",
          "Vy",
          "Yến",
        ];

        for (let k = 1; k <= count; k++) {
          const isPaid = Math.random() > 0.4;
          const randDate = new Date(2023, 9, 1 + Math.floor(Math.random() * 30))
            .toISOString()
            .split("T")[0];
          students.push({
            id: `SV${2024000 + k}`,
            name: `${
              firstNames[Math.floor(Math.random() * firstNames.length)]
            } ${middleNames[Math.floor(Math.random() * middleNames.length)]} ${
              lastNames[Math.floor(Math.random() * lastNames.length)]
            }`,
            dob: `${1 + Math.floor(Math.random() * 28)}/${
              1 + Math.floor(Math.random() * 12)
            }/2004`,
            amount: "50.000đ",
            status: isPaid,
            paidDate: isPaid ? randDate : "-",
          });
        }
        return students;
      }

      function openClassDetail(className, totalStudents) {
        document.getElementById("view-chidoan").classList.add("hidden");
        document.getElementById("view-sinhvien").classList.remove("hidden");
        document.getElementById("current-class-name").innerText = className;

        const students = generateStudents(totalStudents);
        const tbody = document.getElementById("tbody-students");
        let html = "";

        students.forEach((sv) => {
          const statusBadge = sv.status
            ? `<span class="badge badge-success">Đã đóng</span>`
            : `<span class="badge badge-danger">Chưa đóng</span>`;
          const actionBtn = sv.status
            ? `<span style="color:var(--success); font-weight:600"><i class="fas fa-check-circle"></i> Hoàn tất</span>`
            : `<button class="btn-action btn-confirm" onclick="togglePay(this)">Xác nhận thu</button>`;

          html += `
                    <tr>
                        <td><input type="checkbox" class="student-check" onchange="updateCount()"></td>
                        <td>${sv.id}</td>
                        <td style="font-weight:500">${sv.name}</td>
                        <td>${sv.dob}</td>
                        <td>${sv.amount}</td>
                        <td>${statusBadge}</td>
                        <td>${sv.paidDate}</td>
                        <td>${actionBtn}</td>
                    </tr>
                `;
        });
        tbody.innerHTML = html;
        window.scrollTo(0, 0);
        updateCount();
      }

      function backToClassList() {
        document.getElementById("view-sinhvien").classList.add("hidden");
        document.getElementById("view-chidoan").classList.remove("hidden");
      }

      // ===============================================
      // CẬP NHẬT MỚI: HÀM XỬ LÝ NÚT XÁC NHẬN THU TIỀN
      // ===============================================
      function togglePay(btn) {
        // Xác nhận người dùng (tùy chọn)
        if (confirm("Xác nhận đã thu tiền cho sinh viên này?")) {
          // 1. Tìm cái dòng (TR) chứa cái nút bấm
          const tr = btn.closest("tr");

          // 2. Thay đổi trạng thái (Cột thứ 6 - index 5)
          // Từ Badge đỏ -> Badge xanh
          tr.cells[5].innerHTML = `<span class="badge badge-success">Đã đóng</span>`;

          // 3. Cập nhật ngày đóng (Cột thứ 7 - index 6) -> Lấy ngày hôm nay
          const today = new Date();
          const dd = String(today.getDate()).padStart(2, "0");
          const mm = String(today.getMonth() + 1).padStart(2, "0");
          const yyyy = today.getFullYear();
          tr.cells[6].innerText = `${yyyy}-${mm}-${dd}`;

          // 4. Thay nút bấm bằng chữ "Hoàn tất" (Cột thứ 8 - index 7)
          tr.cells[7].innerHTML = `<span style="color:var(--success); font-weight:600"><i class="fas fa-check-circle"></i> Hoàn tất</span>`;
        }
      }

      function updateCount() {
        const checkboxes = document.querySelectorAll(".student-check:checked");
        document.getElementById("selected-count").innerText = checkboxes.length;
      }

      document
        .getElementById("check-all")
        .addEventListener("change", function () {
          const checkboxes = document.querySelectorAll(".student-check");
          checkboxes.forEach((cb) => (cb.checked = this.checked));
          updateCount();
        });

      initFacultyFilter();
      filterClasses();
    </script>
  </body>
</html>
