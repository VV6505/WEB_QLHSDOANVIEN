<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Đoàn Viên - Admin Đoàn Trường</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary: #3782f5;
            --primary-dark: #2563eb;
            --bg: #f1f5f9;
            --white: #ffffff;
            --text: #334155;
            --border: #e2e8f0;
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }

        /* HEADER */
        header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand i { font-size: 24px; }
        .user-panel button { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); padding: 6px 15px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .user-panel button:hover { background: white; color: var(--primary); }

        /* MAIN CONTAINER */
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; flex: 1; width: 100%; }
        
        /* BREADCRUMB & TOOLBAR */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px 20px; border-radius: var(--radius); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .breadcrumb { font-size: 16px; color: #64748b; display: flex; align-items: center; gap: 8px; }
        .breadcrumb span { cursor: pointer; }
        .breadcrumb span:hover { color: var(--primary); text-decoration: underline; }
        .breadcrumb .active { color: var(--primary); font-weight: 700; cursor: default; text-decoration: none; }
        .btn-back { background: #cbd5e1; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; display: none; } /* Ẩn mặc định */

        /* VIEW: KHOA GRID */
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card-item { background: white; padding: 25px; border-radius: var(--radius); box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; transition: 0.3s; border: 1px solid transparent; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .card-item:hover { transform: translateY(-3px); border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(55, 130, 245, 0.15); }
        .card-icon { width: 60px; height: 60px; background: #eff6ff; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 15px; }
        .card-title { font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 5px; }
        .card-sub { font-size: 13px; color: #64748b; }

        /* VIEW: TABLE (SINH VIÊN) */
        .table-wrapper { background: white; border-radius: var(--radius); overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: none; /* Ẩn mặc định */ }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f8fafc; border-bottom: 2px solid var(--border); }
        th, td { padding: 14px 20px; text-align: left; font-size: 14px; border-bottom: 1px solid var(--border); }
        th { font-weight: 700; color: #475569; }
        tr:hover { background: #f8fafc; }
        
        .status-tag { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-active { background: #dcfce7; color: #166534; }
        .status-transferred { background: #fee2e2; color: #991b1b; }

        .btn-action { border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: 0.2s; background: var(--primary); color: white; }
        .btn-action:hover { background: var(--primary-dark); }

        /* MODAL EDIT */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; animation: fadeIn 0.2s; overflow-y: auto; }
        .modal-content { background: white; width: 95%; max-width: 800px; padding: 30px; border-radius: 14px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); margin: 20px 0; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .modal-header h2 { font-size: 20px; color: var(--primary); }
        .close-btn { font-size: 24px; cursor: pointer; color: #94a3b8; }
        .close-btn:hover { color: #ef4444; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group.full { grid-column: span 2; }
        .form-group label { font-size: 13px; font-weight: 600; color: #475569; }
        .form-group input, .form-group select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; transition: 0.2s; }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(55,130,245,0.1); }
        .form-group input:disabled { background: #f1f5f9; color: #64748b; cursor: not-allowed; }

        .modal-footer { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; padding-top: 15px; border-top: 1px solid var(--border); }
        .btn-save { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-cancel { background: #e2e8f0; color: #475569; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }

        footer { text-align: center; padding: 20px; color: #64748b; font-size: 13px; background: white; margin-top: auto; border-top: 1px solid var(--border); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <i class="fa-solid fa-user-shield"></i>
            <div>
                <h1 style="font-size: 18px; margin: 0;">Quản Lý Đoàn Viên</h1>
                <span style="font-size: 12px; opacity: 0.8;">Đoàn Trường</span>
            </div>
        </div>
        <div class="user-panel">
            <span style="margin-right: 10px; font-size: 14px;">Xin chào, Đoàn trường</span>
            <button onclick="window.location.href='pageLogin.html'">Đăng xuất</button>
        </div>
    </header>

    <div class="container">
        <div class="toolbar">
            <div class="breadcrumb" id="breadcrumb">
                <span onclick="goHome()">Trang chủ</span>
                </div>
            <button class="btn-back" id="btnBack" onclick="handleBack()"><i class="fa-solid fa-arrow-left"></i> Quay lại</button>
        </div>

        <div id="viewKhoa" class="grid-view">
            </div>

        <div id="viewLop" class="grid-view" style="display: none;">
            </div>

        <div id="viewSinhVien" class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Mã ĐV</th>
                        <th>Họ tên</th>
                        <th>Ngày sinh</th>
                        <th>Giới tính</th>
                        <th>Chức vụ</th>
                        <th>Trạng thái SH</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="studentTableBody">
                    </tbody>
            </table>
            <div id="emptyState" style="text-align:center; padding: 40px; display:none;">
                <p style="color:#94a3b8">Chưa có đoàn viên nào trong chi đoàn này.</p>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-pen-to-square"></i> Cập Nhật Thông Tin Đoàn Viên</h2>
                <div class="close-btn" onclick="closeModal()">&times;</div>
            </div>
            <div class="modal-body">
                <form id="editForm" class="form-grid">
                    <div class="form-group">
                        <label>Mã Đoàn Viên (MaDV)</label>
                        <input type="text" id="madv" disabled title="Khóa chính không thể sửa">
                    </div>
                    <div class="form-group">
                        <label>Mã Chi Đoàn (maChiDoan)</label>
                        <input type="text" id="machidoan" disabled title="Thuộc chi đoàn hiện tại">
                    </div>
                    
                    <div class="form-group">
                        <label>Họ và Tên (hoTen)</label>
                        <input type="text" id="hoten">
                    </div>
                    <div class="form-group">
                        <label>Giới tính (gioiTinh)</label>
                        <select id="gioitinh">
                            <option value="Nam">Nam</option>
                            <option value="Nữ">Nữ</option>
                            <option value="Khác">Khác</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Ngày sinh (ngaySinh)</label>
                        <input type="date" id="ngaysinh">
                    </div>
                    <div class="form-group">
                        <label>Ngày vào Đoàn (ngayVaoDoan)</label>
                        <input type="date" id="ngayvaodoan">
                    </div>

                    <div class="form-group">
                        <label>Số điện thoại (SDT)</label>
                        <input type="text" id="sdt">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email">
                    </div>

                    <div class="form-group">
                        <label>Chức vụ (chucVu)</label>
                        <select id="chucvu">
                            <option value="Đoàn viên">Đoàn viên</option>
                            <option value="Bí thư">Bí thư</option>
                            <option value="Phó bí thư">Phó bí thư</option>
                            <option value="UV BCH">UV BCH</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Trạng thái SH (trangThaiSH)</label>
                        <select id="trangthaish">
                            <option value="Đang sinh hoạt">Đang sinh hoạt</option>
                            <option value="Đã chuyển đi">Đã chuyển đi</option>
                            <option value="Đã trưởng thành đoàn">Đã trưởng thành đoàn</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Nơi chuyển đến (noiChuyenDen)</label>
                        <input type="text" id="noichuyenden" placeholder="Nếu trạng thái là chuyển đi">
                    </div>
                    <div class="form-group">
                        <label>Ngày chuyển đến (ngayChuyenDen)</label>
                        <input type="date" id="ngaychuyenden">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal()">Hủy bỏ</button>
                <button class="btn-save" onclick="saveStudent()">Lưu thay đổi</button>
            </div>
        </div>
    </div>

    <footer>
        <p>© 2025 Hệ thống Quản lý Đoàn viên - Trường ĐHSPKT | Nhóm 37</p>
    </footer>

    <script>
        // DỮ LIỆU GIẢ LẬP
        const faculties = [
            { id: 'CNTT', name: 'Khoa Công Nghệ Thông Tin', icon: 'fa-laptop-code' },
            { id: 'CK', name: 'Khoa Cơ Khí', icon: 'fa-gears' },
            { id: 'DIEN', name: 'Khoa Điện - Điện Tử', icon: 'fa-bolt' },
            { id: 'SPCN', name: 'Khoa Sư phạm Công Nghiệp', icon: 'fa-chalkboard-user' },
            { id: 'XAYDUNG', name: 'Khoa Xây Dựng', icon: 'fa-building' }
        ];

        const classes = {
            'CNTT': ['22IT1', '22IT2', '22IT3', '21IT1'],
            'CK': ['22CK1', '22CK2'],
            'DIEN': ['22D1', '22D2'],
            'SPCN': ['22SP1', '22SP2'],
            'XAYDUNG': ['22XD1']
        };

        // Dữ liệu sinh viên đầy đủ theo ERD
        let students = [
            { maDV: '22IT001', hoTen: 'Nguyễn Văn A', ngaySinh: '2004-01-01', gioiTinh: 'Nam', sdt: '0905123456', email: 'nva@ute.udn.vn', chucVu: 'Bí thư', maChiDoan: '22IT1', ngayVaoDoan: '2020-03-26', noiChuyenDen: '', ngayChuyenDen: '', trangThaiSH: 'Đang sinh hoạt' },
            { maDV: '22IT002', hoTen: 'Trần Thị B', ngaySinh: '2004-05-20', gioiTinh: 'Nữ', sdt: '0905111222', email: 'ttb@ute.udn.vn', chucVu: 'Đoàn viên', maChiDoan: '22IT1', ngayVaoDoan: '2020-03-26', noiChuyenDen: '', ngayChuyenDen: '', trangThaiSH: 'Đang sinh hoạt' },
            { maDV: '22IT003', hoTen: 'Lê Văn C', ngaySinh: '2004-12-10', gioiTinh: 'Nam', sdt: '0905333444', email: 'lvc@ute.udn.vn', chucVu: 'Đoàn viên', maChiDoan: '22IT1', ngayVaoDoan: '2020-03-26', noiChuyenDen: 'Đơn vị mới A', ngayChuyenDen: '2024-01-01', trangThaiSH: 'Đã chuyển đi' },
            { maDV: '22CK001', hoTen: 'Phạm Văn D', ngaySinh: '2004-02-15', gioiTinh: 'Nam', sdt: '0905999888', email: 'pvd@ute.udn.vn', chucVu: 'Đoàn viên', maChiDoan: '22CK1', ngayVaoDoan: '2020-03-26', noiChuyenDen: '', ngayChuyenDen: '', trangThaiSH: 'Đang sinh hoạt' },
            { maDV: '22SP001', hoTen: 'Hoàng Thị E', ngaySinh: '2004-08-08', gioiTinh: 'Nữ', sdt: '0905777666', email: 'hte@ute.udn.vn', chucVu: 'Đoàn viên', maChiDoan: '22SP1', ngayVaoDoan: '2020-03-26', noiChuyenDen: '', ngayChuyenDen: '', trangThaiSH: 'Đang sinh hoạt' }
        ];

        // STATE MANAGEMENT
        let currentLevel = 'KHOA'; // KHOA | LOP | SINHVIEN
        let selectedFaculty = null;
        let selectedClass = null;
        let editingStudentId = null;

        const viewKhoa = document.getElementById('viewKhoa');
        const viewLop = document.getElementById('viewLop');
        const viewSinhVien = document.getElementById('viewSinhVien');
        const breadcrumb = document.getElementById('breadcrumb');
        const btnBack = document.getElementById('btnBack');

        // INIT
        function init() {
            renderFaculties();
        }

        // RENDER FUNCTIONS
        function renderFaculties() {
            viewKhoa.innerHTML = faculties.map(f => `
                <div class="card-item" onclick="selectFaculty('${f.id}', '${f.name}')">
                    <div class="card-icon"><i class="fa-solid ${f.icon}"></i></div>
                    <div class="card-title">${f.name}</div>
                    <div class="card-sub">${classes[f.id] ? classes[f.id].length : 0} Chi đoàn</div>
                </div>
            `).join('');
            
            updateView('KHOA');
        }

        function renderClasses(facultyId) {
            const classList = classes[facultyId] || [];
            viewLop.innerHTML = classList.map(c => `
                <div class="card-item" onclick="selectClass('${c}')">
                    <div class="card-icon" style="color: #10b981; background: #ecfdf5"><i class="fa-solid fa-users-rectangle"></i></div>
                    <div class="card-title">Chi đoàn ${c}</div>
                    <div class="card-sub">Bấm để xem danh sách</div>
                </div>
            `).join('');
            
            updateView('LOP');
        }

        function renderStudents(classId) {
            const list = students.filter(s => s.maChiDoan === classId);
            const tbody = document.getElementById('studentTableBody');
            
            if (list.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                tbody.innerHTML = '';
            } else {
                document.getElementById('emptyState').style.display = 'none';
                tbody.innerHTML = list.map(s => {
                    let statusClass = s.trangThaiSH === 'Đang sinh hoạt' ? 'status-active' : 'status-transferred';
                    return `
                        <tr>
                            <td style="font-weight:600; color:var(--primary)">${s.maDV}</td>
                            <td>${s.hoTen}</td>
                            <td>${formatDate(s.ngaySinh)}</td>
                            <td>${s.gioiTinh}</td>
                            <td>${s.chucVu}</td>
                            <td><span class="status-tag ${statusClass}">${s.trangThaiSH}</span></td>
                            <td>
                                <button class="btn-action" onclick="openEditModal('${s.maDV}')">
                                    <i class="fa-solid fa-pen"></i> Sửa
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            updateView('SINHVIEN');
        }

        // NAVIGATION LOGIC
        function selectFaculty(id, name) {
            selectedFaculty = { id, name };
            renderClasses(id);
        }

        function selectClass(id) {
            selectedClass = id;
            renderStudents(id);
        }

        function goHome() {
            selectedFaculty = null;
            selectedClass = null;
            renderFaculties();
        }

        function handleBack() {
            if (currentLevel === 'SINHVIEN') {
                renderClasses(selectedFaculty.id);
            } else if (currentLevel === 'LOP') {
                goHome();
            }
        }

        function updateView(level) {
            currentLevel = level;
            
            // Hide all views
            viewKhoa.style.display = 'none';
            viewLop.style.display = 'none';
            viewSinhVien.style.display = 'none';

            // Show current view and Update breadcrumb
            let breadHtml = `<span onclick="goHome()">Trang chủ</span>`;
            
            if (level === 'KHOA') {
                viewKhoa.style.display = 'grid';
                btnBack.style.display = 'none';
            } 
            else if (level === 'LOP') {
                viewLop.style.display = 'grid';
                btnBack.style.display = 'block';
                breadHtml += ` <i class="fa-solid fa-chevron-right" style="font-size:12px; margin:0 5px"></i> <span class="active">${selectedFaculty.name}</span>`;
            } 
            else if (level === 'SINHVIEN') {
                viewSinhVien.style.display = 'block';
                btnBack.style.display = 'block';
                breadHtml += ` <i class="fa-solid fa-chevron-right" style="font-size:12px; margin:0 5px"></i> <span onclick="renderClasses('${selectedFaculty.id}')">${selectedFaculty.name}</span>`;
                breadHtml += ` <i class="fa-solid fa-chevron-right" style="font-size:12px; margin:0 5px"></i> <span class="active">Chi đoàn ${selectedClass}</span>`;
            }

            breadcrumb.innerHTML = breadHtml;
        }

        // MODAL LOGIC
        function openEditModal(id) {
            const s = students.find(x => x.maDV === id);
            if (!s) return;
            
            editingStudentId = id;
            
            // Fill Data to Form
            document.getElementById('madv').value = s.maDV;
            document.getElementById('hoten').value = s.hoTen;
            document.getElementById('ngaysinh').value = s.ngaySinh;
            document.getElementById('gioitinh').value = s.gioiTinh;
            document.getElementById('sdt').value = s.sdt;
            document.getElementById('email').value = s.email;
            document.getElementById('chucvu').value = s.chucVu;
            document.getElementById('machidoan').value = s.maChiDoan;
            document.getElementById('ngayvaodoan').value = s.ngayVaoDoan;
            document.getElementById('noichuyenden').value = s.noiChuyenDen || '';
            document.getElementById('ngaychuyenden').value = s.ngayChuyenDen || '';
            document.getElementById('trangthaish').value = s.trangThaiSH;

            document.getElementById('editModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            editingStudentId = null;
        }

        function saveStudent() {
            const index = students.findIndex(x => x.maDV === editingStudentId);
            if (index !== -1) {
                // Update object based on inputs
                students[index].hoTen = document.getElementById('hoten').value;
                students[index].ngaySinh = document.getElementById('ngaysinh').value;
                students[index].gioiTinh = document.getElementById('gioitinh').value;
                students[index].sdt = document.getElementById('sdt').value;
                students[index].email = document.getElementById('email').value;
                students[index].chucVu = document.getElementById('chucvu').value;
                students[index].ngayVaoDoan = document.getElementById('ngayvaodoan').value;
                students[index].noiChuyenDen = document.getElementById('noichuyenden').value;
                students[index].ngayChuyenDen = document.getElementById('ngaychuyenden').value;
                students[index].trangThaiSH = document.getElementById('trangthaish').value;
                
                alert('✅ Đã cập nhật thông tin thành công!');
                closeModal();
                renderStudents(selectedClass); // Re-render table
            }
        }

        // HELPER
        function formatDate(dateString) {
            if (!dateString) return '';
            const [y, m, d] = dateString.split('-');
            return `${d}/${m}/${y}`;
        }

        // Start
        init();

    </script>
</body>
</html>